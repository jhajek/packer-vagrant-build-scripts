# Instruction to build OVA to EC2 instance

This document will walk you through the sample code to build and load/import an OVA file generated by Packer into AWS and register it as an AMI.  

Packer Docs located at: [https://packer.io/docs/post-processors/amazon-import.html](https://packer.io/docs/post-processors/amazon-import.html "Documentation for AWS importer")

## How to Pass AWS credentials securely

Using the `variables-sample.json` file template I set up in the [ITMT-430 Packer demo repo](https://github.com/jhajek/packer-vagrant-build-scripts/tree/master/packer/itmt430 "ITMT-430 Packer demo repo").  Create environment variables for your AWS access, secret, S3 bucket name, and AWS region.

Syntax can be found here: [https://packer.io/docs/templates/user-variables.html](https://packer.io/docs/templates/user-variables.html "Packer user environment variables configuration web page")

There are a few ways to do this.  I will show you one here, but there are much more secure and manageable ways to do this (see [Hashicorp Vault](https://www.vaultproject.io/ "Website for Vault secret management")).

Copy the file: ```variables-sample.json``` into a file named ```variables.json```.  This will give you a template along with having a file that will pass environment variables into the Packer build process.

## Pre-req steps to set up AWS configuration

Follow these steps first to configure AWS to be ready to receive your OVA file:
[https://docs.aws.amazon.com/vm-import/latest/userguide/vmie_prereqs.html#vmimport-role](https://docs.aws.amazon.com/vm-import/latest/userguide/vmie_prereqs.html#vmimport-role "Configures Roles for vmimporting on AWS")

## Set Packer Builders Values Export Mode to OVA

The template provided here has this change already added, but you can add this one value to any existing Packer Builder Template. It will cause the default build artifact to become and OVA instead of an OVF packaged file.  

[https://packer.io/docs/builders/virtualbox-iso.html](https://packer.io/docs/builders/virtualbox-iso.html "Packer documentation on how to build a virtualbox artifact as OVA).

The OVA format is part of the [Open Virtualization Format](https://en.wikipedia.org/wiki/Open_Virtualization_Format "Wikipedia OVF deescription page")

```json
 "format": "ova",
 ```

The above line was added to this template so the AWS importer (which requires OVA) can accept your virtual machine.  
Once all of the above is set, execute this command: ```packer build --var-file=variables.json .\ubuntu18045-ec2.json```

Depending on Upload speed, this process could take some time.  The OVA built is near 1 GB, that has to be uploaded to AWS.  

What the packer post-processor is doing is essentially running this:  [https://docs.aws.amazon.com/vm-import/latest/userguide/vmimport-image-import.html](https://docs.aws.amazon.com/vm-import/latest/userguide/vmimport-image-import.html "AWS vm importer documentation")

## CleanUp of Artifacts

Take note of Packer's comment: *After tagging is completed, the OVA uploaded to S3 will be removed.* If you leave large amounts of 1GB AMIs on AWS after awhile you could incur a small storage charge.
